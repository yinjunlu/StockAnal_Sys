{% extends "layout.html" %}

{% block title %}基本面分析 - {{ stock_code }} - 智能分析系统{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div id="alerts-container"></div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <h5 class="mb-0">基本面分析</h5>
                </div>
                <div class="card-body py-2">
                    <form id="fundamental-form" class="row g-2">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">股票代码</span>
                                <input type="text" class="form-control" id="stock-code" placeholder="例如: 600519" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">市场</span>
                                <select class="form-select" id="market-type">
                                    <option value="A" selected>A股</option>
<!--                                    <option value="HK">港股</option>-->
<!--                                    <option value="US">美股</option>-->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                <i class="fas fa-search"></i> 分析
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 移动loading指示器到这里 -->
    <div id="loading-indicator" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-2">正在获取基本面数据，请稍候...</p>
    </div>

    <div id="fundamental-result" style="display: none;">
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">财务概况</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-7">
                                <h3 id="stock-name" class="mb-0 fs-4"></h3>
                                <p id="stock-info" class="text-muted mb-0 small"></p>
                            </div>
                            <div class="col-md-5 text-end">
                                <span id="fundamental-score" class="badge rounded-pill score-pill"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>估值指标</h6>
                                <ul class="list-unstyled mt-1 mb-0 small">
                                    <li><span class="text-muted">PE(TTM):</span> <span id="pe-ttm"></span></li>
                                    <li><span class="text-muted">PB:</span> <span id="pb"></span></li>
                                    <li><span class="text-muted">PS(TTM):</span> <span id="ps-ttm"></span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>盈利能力</h6>
                                <ul class="list-unstyled mt-1 mb-0 small">
                                    <li><span class="text-muted">ROE:</span> <span id="roe"></span></li>
                                    <li><span class="text-muted">毛利率:</span> <span id="gross-margin"></span></li>
                                    <li><span class="text-muted">净利润率:</span> <span id="net-profit-margin"></span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">成长性分析</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>营收增长</h6>
                                <ul class="list-unstyled mt-1 mb-0 small">
                                    <li><span class="text-muted">3年CAGR:</span> <span id="revenue-growth-3y"></span></li>
                                    <li><span class="text-muted">5年CAGR:</span> <span id="revenue-growth-5y"></span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>利润增长</h6>
                                <ul class="list-unstyled mt-1 mb-0 small">
                                    <li><span class="text-muted">3年CAGR:</span> <span id="profit-growth-3y"></span></li>
                                    <li><span class="text-muted">5年CAGR:</span> <span id="profit-growth-5y"></span></li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div id="growth-chart" style="height: 150px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">估值评分</h5>
                    </div>
                    <div class="card-body">
                        <div id="valuation-chart" style="height: 200px;"></div>
                        <p id="valuation-comment" class="small text-muted mt-2"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">财务健康评分</h5>
                    </div>
                    <div class="card-body">
                        <div id="financial-chart" style="height: 200px;"></div>
                        <p id="financial-comment" class="small text-muted mt-2"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">成长性评分</h5>
                    </div>
                    <div class="card-body">
                        <div id="growth-score-chart" style="height: 200px;"></div>
                        <p id="growth-comment" class="small text-muted mt-2"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#fundamental-form').submit(function(e) {
            e.preventDefault();
            const stockCode = $('#stock-code').val().trim();
            const marketType = $('#market-type').val();

            if (!stockCode) {
                showError('请输入股票代码！');
                return;
            }

            fetchFundamentalAnalysis(stockCode, marketType);
        });
    });

    function fetchFundamentalAnalysis(stockCode, marketType) {
        showLoading();
        console.log(`正在请求基本面数据: 股票代码=${stockCode}, 市场类型=${marketType}`);

        $.ajax({
            url: '/api/fundamental_analysis',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stock_code: stockCode,
                market_type: marketType
            }),
            success: function(response) {
                hideLoading();
                console.log("基本面分析API响应:", response);  // 添加调试日志
                renderFundamentalAnalysis(response, stockCode);
                $('#fundamental-result').show();
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error("基本面分析API错误状态:", status);
                console.error("基本面分析API错误:", error);
                console.error("基本面分析API响应:", xhr.responseJSON || xhr.responseText);
                
                let errorMsg = '获取基本面分析失败';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                } else if (error) {
                    errorMsg += ': ' + error;
                }
                showError(errorMsg);
            }
        });
    }

    function renderFundamentalAnalysis(data, stockCode) {
        try {
            console.log("基本面数据:", data);  // 调试用
            
            // 检查数据完整性
            if (!data || !data.details) {
                showError('基本面数据格式不正确');
                return;
            }
            
            // 设置基本信息
            const indicators = data.details.indicators || {};
            const growth = data.details.growth || {};
            
            $('#stock-name').text(indicators.stock_name || stockCode);
            $('#stock-info').text(indicators.industry || '未知行业');

            // 设置评分
            const totalScore = data.total || 50;
            const scoreClass = getScoreColorClass(totalScore);
            $('#fundamental-score').text(totalScore).removeClass().addClass('badge rounded-pill score-pill ' + scoreClass);

            // 设置估值指标
            $('#pe-ttm').text(formatNumber(indicators.pe_ttm, 2));
            $('#pb').text(formatNumber(indicators.pb, 2));
            $('#ps-ttm').text(formatNumber(indicators.ps_ttm, 2));

            // 设置盈利能力
            $('#roe').text(formatPercent(indicators.roe, 2));
            $('#gross-margin').text(formatPercent(indicators.gross_margin, 2));
            $('#net-profit-margin').text(formatPercent(indicators.net_profit_margin, 2));

            // 设置成长率
            $('#revenue-growth-3y').text(formatPercent(growth.revenue_growth_3y, 2));
            $('#revenue-growth-5y').text(formatPercent(growth.revenue_growth_5y, 2));
            $('#profit-growth-3y').text(formatPercent(growth.profit_growth_3y, 2));
            $('#profit-growth-5y').text(formatPercent(growth.profit_growth_5y, 2));

            // 评论
            const valuationScore = data.valuation || 50;
            const financialScore = data.financial_health || 50;
            const growthScore = data.growth || 50;
            
            $('#valuation-comment').text("估值处于行业" + (valuationScore > 60 ? "合理水平" : "偏高水平"));
            $('#financial-comment').text("财务状况" + (financialScore > 60 ? "良好" : "一般"));
            $('#growth-comment').text("成长性" + (growthScore > 60 ? "较好" : "一般"));

            // 渲染图表
            renderValuationChart(valuationScore);
            renderFinancialChart(financialScore);
            renderGrowthScoreChart(growthScore);
            renderGrowthChart(growth);
        } catch (error) {
            console.error("渲染基本面数据出错:", error);
            showError('渲染基本面数据时出错: ' + error.message);
        }
    }

    function renderValuationChart(score) {
        try {
            // 确保score是有效数字
            score = parseFloat(score) || 50;
            
            const options = {
                series: [score],
                chart: {
                    height: 200,
                    type: 'radialBar',
                },
                plotOptions: {
                    radialBar: {
                        hollow: {
                            size: '70%',
                        },
                        dataLabels: {
                            name: {
                                fontSize: '22px',
                            },
                            value: {
                                fontSize: '16px',
                            },
                            total: {
                                show: true,
                                label: '估值',
                                formatter: function() {
                                    return score;
                                }
                            }
                        }
                    }
                },
                colors: ['#1ab7ea'],
                labels: ['估值'],
            };

            $('#valuation-chart').empty();
            const chart = new ApexCharts(document.querySelector("#valuation-chart"), options);
            chart.render();
        } catch (error) {
            console.error("渲染估值图表出错:", error);
            $('#valuation-chart').html('<div class="alert alert-danger">估值图表加载失败</div>');
        }
    }

    function renderFinancialChart(score) {
        try {
            // 确保score是有效数字
            score = parseFloat(score) || 50;
            
            const options = {
                series: [score],
                chart: {
                    height: 200,
                    type: 'radialBar',
                },
                plotOptions: {
                    radialBar: {
                        hollow: {
                            size: '70%',
                        },
                        dataLabels: {
                            name: {
                                fontSize: '22px',
                            },
                            value: {
                                fontSize: '16px',
                            },
                            total: {
                                show: true,
                                label: '财务',
                                formatter: function() {
                                    return score;
                                }
                            }
                        }
                    }
                },
                colors: ['#20E647'],
                labels: ['财务'],
            };

            $('#financial-chart').empty();
            const chart = new ApexCharts(document.querySelector("#financial-chart"), options);
            chart.render();
        } catch (error) {
            console.error("渲染财务图表出错:", error);
            $('#financial-chart').html('<div class="alert alert-danger">财务图表加载失败</div>');
        }
    }

    function renderGrowthScoreChart(score) {
        try {
            // 确保score是有效数字
            score = parseFloat(score) || 50;
            
            const options = {
                series: [score],
                chart: {
                    height: 200,
                    type: 'radialBar',
                },
                plotOptions: {
                    radialBar: {
                        hollow: {
                            size: '70%',
                        },
                        dataLabels: {
                            name: {
                                fontSize: '22px',
                            },
                            value: {
                                fontSize: '16px',
                            },
                            total: {
                                show: true,
                                label: '成长',
                                formatter: function() {
                                    return score;
                                }
                            }
                        }
                    }
                },
                colors: ['#F9CE1D'],
                labels: ['成长'],
            };

            $('#growth-score-chart').empty();
            const chart = new ApexCharts(document.querySelector("#growth-score-chart"), options);
            chart.render();
        } catch (error) {
            console.error("渲染成长图表出错:", error);
            $('#growth-score-chart').html('<div class="alert alert-danger">成长图表加载失败</div>');
        }
    }

    function renderGrowthChart(growthData) {
        try {
            // 确保数据有效
            growthData = growthData || {};
            
            const revenue3y = parseFloat(growthData.revenue_growth_3y) || 0;
            const revenue5y = parseFloat(growthData.revenue_growth_5y) || 0;
            const profit3y = parseFloat(growthData.profit_growth_3y) || 0;
            const profit5y = parseFloat(growthData.profit_growth_5y) || 0;
            
            const options = {
                series: [{
                    name: '营收增长率',
                    data: [revenue3y, revenue5y]
                }, {
                    name: '利润增长率',
                    data: [profit3y, profit5y]
                }],
                chart: {
                    type: 'bar',
                    height: 150,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded'
                    },
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: ['3年CAGR', '5年CAGR'],
                },
                yaxis: {
                    title: {
                        text: '百分比 (%)'
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val + "%"
                        }
                    }
                }
            };

            $('#growth-chart').empty();
            const chart = new ApexCharts(document.querySelector("#growth-chart"), options);
            chart.render();
        } catch (error) {
            console.error("渲染成长柱状图出错:", error);
            $('#growth-chart').html('<div class="alert alert-danger">成长柱状图加载失败</div>');
        }
    }

    // 显示错误信息
    function showError(message) {
        // 创建或获取alerts容器
        const alertsContainer = $('#alerts-container');
        
        // 创建警告框
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>${message}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // 添加到容器
        alertsContainer.html(alertHtml);
        
        // 滚动到顶部
        window.scrollTo(0, 0);
    }

    // 显示加载中
    function showLoading() {
        // 隐藏分析结果
        $('#fundamental-result').hide();
        // 显示加载指示器
        $('#loading-indicator').show();
    }

    // 隐藏加载中
    function hideLoading() {
        $('#loading-indicator').hide();
    }

    // 格式化数字
    function formatNumber(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) {
            return '--';
        }
        return parseFloat(value).toFixed(decimals);
    }

    // 格式化百分比
    function formatPercent(value, decimals = 2) {
        if (value === null || value === undefined || isNaN(value)) {
            return '--';
        }
        return parseFloat(value).toFixed(decimals) + '%';
    }

    // 获取评分颜色类
    function getScoreColorClass(score) {
        if (score >= 80) return 'bg-success';
        if (score >= 60) return 'bg-primary';
        if (score >= 40) return 'bg-warning';
        return 'bg-danger';
    }

    function renderVolatilityChart(data) {
        // 使用后端返回的实际波动率数据
        const volatilityData = data.volatility_history || [];
        // ... 渲染图表
    }
</script>
{% endblock %}